<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Affordability Model Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .paper-ref {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid var(--primary);
        }

        .paper-ref h3 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .paper-claim {
            font-style: italic;
            color: var(--warning);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h2 .icon {
            font-size: 1.2rem;
        }

        .parameter-group {
            margin-bottom: 1.5rem;
        }

        .parameter-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .parameter-group .value {
            font-weight: 600;
            color: var(--primary);
            font-family: 'Fira Code', monospace;
        }

        .parameter-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-input);
            outline: none;
            -webkit-appearance: none;
        }

        .parameter-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
            transition: transform 0.2s;
        }

        .parameter-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .parameter-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
            opacity: 0.7;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .result-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .result-card .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .result-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Fira Code', monospace;
        }

        .result-card.baseline .value {
            color: var(--text-secondary);
        }

        .result-card.paper .value {
            color: var(--warning);
        }

        .result-card.yours .value {
            color: var(--secondary);
        }

        .result-card .delta {
            font-size: 0.8rem;
            margin-top: 0.3rem;
        }

        .delta.positive {
            color: var(--secondary);
        }

        .delta.negative {
            color: var(--danger);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .comparison-table th {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .comparison-table .paper-col {
            color: var(--warning);
        }

        .comparison-table .yours-col {
            color: var(--secondary);
            font-weight: 600;
        }

        .toggle-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .toggle-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: var(--border);
        }

        .section-divider {
            border: 0;
            height: 1px;
            background: var(--border);
            margin: 1.5rem 0;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge.paper {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .badge.alt {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
        }

        .insight-box {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .insight-box h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .insight-box p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .reset-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .help-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 0.4rem;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .label-with-help {
            display: flex;
            align-items: center;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: modalIn 0.2s ease-out;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.1rem;
            color: var(--primary);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .modal-body p {
            margin-bottom: 0.75rem;
        }

        .modal-body p:last-child {
            margin-bottom: 0;
        }

        .modal-body strong {
            color: var(--text-primary);
        }

        .modal-body .highlight {
            background: rgba(37, 99, 235, 0.15);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            margin: 0.75rem 0;
        }

        .modal-body .formula {
            font-family: 'Fira Code', monospace;
            background: var(--bg-input);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            display: inline-block;
            margin: 0.5rem 0;
        }
    </style>
</head>

<body>
    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title">Parameter Help</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üè† Housing Affordability Model Explorer</h1>
            <p class="subtitle">Interactive simulation of Fingleton, Fuerst & Szumilo (2018)</p>
            <div class="paper-ref">
                <h3>Paper's Core Claim:</h3>
                <p class="paper-claim">"Building 1.6 million homes in London would only reduce affordability from 11.7 ‚Üí
                    10.1"</p>
            </div>
        </header>

        <div class="main-grid">
            <div class="controls-panel">
                <div class="card">
                    <div class="header-row">
                        <h2><span class="icon">‚öôÔ∏è</span> Model Parameters</h2>
                        <button class="reset-btn" onclick="resetToDefaults()">Reset to Paper</button>
                    </div>

                    <div class="toggle-group">
                        <button class="toggle-btn active" id="btn-demand" onclick="setDemandMode(true)">With Induced
                            Demand</button>
                        <button class="toggle-btn" id="btn-supply" onclick="setDemandMode(false)">Supply Only</button>
                    </div>

                    <div class="parameter-group">
                        <label>
                            <span class="label-with-help">Supply Increase (%)<button class="help-btn"
                                    onclick="showHelp('supply')">?</button></span>
                            <span class="value" id="supply-value">48%</span>
                        </label>
                        <input type="range" id="supply-slider" min="5" max="80" value="48" step="1"
                            oninput="updateModel()">
                        <p class="parameter-desc">Paper tested 5%, 15%, and 48% (1.6M homes)</p>
                    </div>

                    <hr class="section-divider">
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">Key Model
                        Coefficients</p>

                    <div class="parameter-group">
                        <label>
                            <span class="label-with-help">Supply Effect (b‚ÇÇ)<button class="help-btn"
                                    onclick="showHelp('b2')">?</button></span>
                            <span class="value" id="b2-value">-0.97</span>
                        </label>
                        <input type="range" id="b2-slider" min="-3" max="-0.5" value="-0.97" step="0.01"
                            oninput="updateModel()">
                        <p class="parameter-desc">Paper: -0.97 | More negative = stronger supply effect</p>
                    </div>

                    <div class="parameter-group">
                        <label>
                            <span class="label-with-help">Demand Response (b‚ÇÅ multiplier)<button class="help-btn"
                                    onclick="showHelp('b1')">?</button></span>
                            <span class="value" id="b1-value">1.0x</span>
                        </label>
                        <input type="range" id="b1-slider" min="0" max="1.5" value="1.0" step="0.05"
                            oninput="updateModel()">
                        <p class="parameter-desc">1.0 = Paper's assumption | 0 = No induced demand</p>
                    </div>

                    <div class="parameter-group">
                        <label>
                            <span class="label-with-help">Filtering Multiplier<button class="help-btn"
                                    onclick="showHelp('filter')">?</button></span>
                            <span class="value" id="filter-value">1.0x</span>
                        </label>
                        <input type="range" id="filter-slider" min="1" max="2.5" value="1" step="0.1"
                            oninput="updateModel()">
                        <p class="parameter-desc">Paper ignores filtering (1.0x) | Literature: 1.5-2.5x</p>
                    </div>

                    <div class="parameter-group">
                        <label>
                            <span class="label-with-help">Commuting Evolution<button class="help-btn"
                                    onclick="showHelp('commute')">?</button></span>
                            <span class="value" id="commute-value">2001 (Paper)</span>
                        </label>
                        <input type="range" id="commute-slider" min="0" max="3" value="0" step="1"
                            oninput="updateModel()">
                        <p class="parameter-desc">How much commuting patterns evolved since 2001</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h2><span class="icon">üí°</span> Key Insight</h2>
                    <div class="insight-box" id="insight-box">
                        <h4>Adjust parameters to see impact</h4>
                        <p>Move the sliders to explore how different assumptions change the model's predictions about
                            housing affordability.</p>
                    </div>
                </div>
            </div>

            <div class="results-panel">
                <div class="card">
                    <h2><span class="icon">üìä</span> Affordability Predictions</h2>

                    <div class="results-grid">
                        <div class="result-card baseline">
                            <div class="label">2012 Baseline</div>
                            <div class="value">11.70</div>
                            <div class="delta">London avg</div>
                        </div>
                        <div class="result-card paper">
                            <div class="label"><span class="badge paper">Paper</span></div>
                            <div class="value" id="paper-result">10.09</div>
                            <div class="delta" id="paper-delta">-1.61</div>
                        </div>
                        <div class="result-card yours">
                            <div class="label"><span class="badge alt">Your Model</span></div>
                            <div class="value" id="your-result">10.09</div>
                            <div class="delta" id="your-delta">-1.61</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="affordabilityChart"></canvas>
                    </div>

                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Supply Increase</th>
                                <th class="paper-col">Paper's Prediction</th>
                                <th class="yours-col">Your Model</th>
                                <th>Difference</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Model constants
        const BASELINE_AFFORDABILITY = 11.70;
        const BASELINE_PRICE = 438960;
        const BASELINE_WAGE = 37520;
        const ENGLAND_AVG = 7.5;

        // Paper's predictions for reference
        const paperPredictions = {
            5: { withDemand: 11.49, supplyOnly: 11.42 },
            10: { withDemand: 11.28, supplyOnly: 11.14 },
            15: { withDemand: 11.07, supplyOnly: 10.85 },
            20: { withDemand: 10.86, supplyOnly: 10.56 },
            30: { withDemand: 10.44, supplyOnly: 9.98 },
            48: { withDemand: 10.09, supplyOnly: 9.73 },
            60: { withDemand: 9.50, supplyOnly: 9.20 },
            80: { withDemand: 8.70, supplyOnly: 8.30 }
        };

        const commuteLabels = ['2001 (Paper)', '2012 Evolved', 'Strong Evolution', 'Post-Pandemic'];
        const commuteMultipliers = [1.0, 1.15, 1.30, 1.50];

        let includeDemand = true;
        let chart = null;

        function setDemandMode(withDemand) {
            includeDemand = withDemand;
            document.getElementById('btn-demand').classList.toggle('active', withDemand);
            document.getElementById('btn-supply').classList.toggle('active', !withDemand);
            updateModel();
        }

        function resetToDefaults() {
            document.getElementById('supply-slider').value = 48;
            document.getElementById('b2-slider').value = -0.97;
            document.getElementById('b1-slider').value = 1.0;
            document.getElementById('filter-slider').value = 1.0;
            document.getElementById('commute-slider').value = 0;
            includeDemand = true;
            document.getElementById('btn-demand').classList.add('active');
            document.getElementById('btn-supply').classList.remove('active');
            updateModel();
        }

        function simulateAffordability(supplyPct, b2, b1Mult, filterMult, commuteMult, withDemand) {
            // Base effects calibrated to paper's results
            // Paper: 5% supply -> ~¬£10k price drop with supply coefficient of -0.97
            const b2Ratio = b2 / -0.97;

            // Supply effect (negative = price drops)
            let supplyEffect = -10000 * (supplyPct / 5) * b2Ratio * filterMult * commuteMult;

            // Demand effect (if new homes bring workers)
            let demandEffect = 0;
            if (withDemand) {
                demandEffect = 2500 * (supplyPct / 5) * b1Mult;
            }

            // Net price change
            const netPriceChange = supplyEffect + demandEffect;
            const newPrice = BASELINE_PRICE + netPriceChange;

            // Affordability
            return newPrice / BASELINE_WAGE;
        }

        function getPaperPrediction(supplyPct, withDemand) {
            // Interpolate paper predictions
            const keys = Object.keys(paperPredictions).map(Number).sort((a, b) => a - b);

            if (paperPredictions[supplyPct]) {
                return withDemand ? paperPredictions[supplyPct].withDemand : paperPredictions[supplyPct].supplyOnly;
            }

            // Linear interpolation
            let lower = keys[0], upper = keys[keys.length - 1];
            for (let i = 0; i < keys.length - 1; i++) {
                if (keys[i] <= supplyPct && keys[i + 1] >= supplyPct) {
                    lower = keys[i];
                    upper = keys[i + 1];
                    break;
                }
            }

            const lowerVal = withDemand ? paperPredictions[lower].withDemand : paperPredictions[lower].supplyOnly;
            const upperVal = withDemand ? paperPredictions[upper].withDemand : paperPredictions[upper].supplyOnly;

            const t = (supplyPct - lower) / (upper - lower);
            return lowerVal + t * (upperVal - lowerVal);
        }

        function updateModel() {
            const supplyPct = parseFloat(document.getElementById('supply-slider').value);
            const b2 = parseFloat(document.getElementById('b2-slider').value);
            const b1Mult = parseFloat(document.getElementById('b1-slider').value);
            const filterMult = parseFloat(document.getElementById('filter-slider').value);
            const commuteIdx = parseInt(document.getElementById('commute-slider').value);
            const commuteMult = commuteMultipliers[commuteIdx];

            // Update display values
            document.getElementById('supply-value').textContent = supplyPct + '%';
            document.getElementById('b2-value').textContent = b2.toFixed(2);
            document.getElementById('b1-value').textContent = b1Mult.toFixed(2) + 'x';
            document.getElementById('filter-value').textContent = filterMult.toFixed(1) + 'x';
            document.getElementById('commute-value').textContent = commuteLabels[commuteIdx];

            // Calculate predictions
            const paperResult = getPaperPrediction(supplyPct, includeDemand);
            const yourResult = simulateAffordability(supplyPct, b2, b1Mult, filterMult, commuteMult, includeDemand);

            // Update result cards
            document.getElementById('paper-result').textContent = paperResult.toFixed(2);
            document.getElementById('your-result').textContent = yourResult.toFixed(2);

            const paperDelta = paperResult - BASELINE_AFFORDABILITY;
            const yourDelta = yourResult - BASELINE_AFFORDABILITY;

            document.getElementById('paper-delta').textContent = (paperDelta >= 0 ? '+' : '') + paperDelta.toFixed(2);
            document.getElementById('paper-delta').className = 'delta ' + (paperDelta < 0 ? 'positive' : 'negative');

            document.getElementById('your-delta').textContent = (yourDelta >= 0 ? '+' : '') + yourDelta.toFixed(2);
            document.getElementById('your-delta').className = 'delta ' + (yourDelta < 0 ? 'positive' : 'negative');

            // Update insight box
            updateInsight(paperResult, yourResult, supplyPct, b2, filterMult, commuteIdx);

            // Update chart
            updateChart(b2, b1Mult, filterMult, commuteMult);

            // Update comparison table
            updateComparisonTable(b2, b1Mult, filterMult, commuteMult);
        }

        function updateInsight(paperResult, yourResult, supplyPct, b2, filterMult, commuteIdx) {
            const insightBox = document.getElementById('insight-box');
            const diff = paperResult - yourResult;
            const pctBetter = ((paperResult - yourResult) / (BASELINE_AFFORDABILITY - paperResult) * 100);

            let title, message;

            if (Math.abs(diff) < 0.1) {
                title = "Matching the Paper's Predictions";
                message = "With current parameters, your model closely matches the paper's predictions. Try adjusting the supply coefficient or adding filtering effects to see alternative outcomes.";
            } else if (yourResult <= ENGLAND_AVG) {
                title = "üéØ Reaching England Average!";
                message = `With these parameters, a ${supplyPct}% supply increase could reduce London affordability to ${yourResult.toFixed(2)} ‚Äî matching or beating England's average of 7.5. This challenges the paper's pessimism.`;
            } else if (diff > 1.5) {
                title = "üìà Substantial Improvement Over Paper";
                message = `Your model predicts ${diff.toFixed(1)} points MORE improvement than the paper (${yourResult.toFixed(2)} vs ${paperResult.toFixed(2)}). The paper may significantly underestimate supply effects.`;
            } else if (diff > 0.5) {
                title = "Moderate Improvement";
                message = `Your model shows ${diff.toFixed(1)} points more improvement. Key drivers: ${filterMult > 1 ? 'filtering effects, ' : ''}${b2 < -1.2 ? 'stronger supply effect, ' : ''}${commuteIdx > 0 ? 'evolved commuting patterns' : ''}.`;
            } else {
                title = "Similar to Paper";
                message = "Your parameters produce results close to the paper. The paper's conclusions may be reasonable under these specific assumptions.";
            }

            insightBox.innerHTML = `<h4>${title}</h4><p>${message}</p>`;
        }

        function updateChart(b2, b1Mult, filterMult, commuteMult) {
            const supplyLevels = [5, 15, 30, 48, 60, 80];

            const paperData = supplyLevels.map(s => getPaperPrediction(s, includeDemand));
            const yourData = supplyLevels.map(s =>
                simulateAffordability(s, b2, b1Mult, filterMult, commuteMult, includeDemand)
            );

            if (chart) {
                chart.data.datasets[0].data = paperData;
                chart.data.datasets[1].data = yourData;
                chart.update();
            } else {
                const ctx = document.getElementById('affordabilityChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: supplyLevels.map(s => s + '%'),
                        datasets: [
                            {
                                label: "Paper's Prediction",
                                data: paperData,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.3
                            },
                            {
                                label: 'Your Model',
                                data: yourData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#94a3b8' }
                            },
                            annotation: {
                                annotations: {
                                    baseline: {
                                        type: 'line',
                                        yMin: BASELINE_AFFORDABILITY,
                                        yMax: BASELINE_AFFORDABILITY,
                                        borderColor: 'rgba(148, 163, 184, 0.5)',
                                        borderDash: [5, 5]
                                    },
                                    england: {
                                        type: 'line',
                                        yMin: ENGLAND_AVG,
                                        yMax: ENGLAND_AVG,
                                        borderColor: 'rgba(16, 185, 129, 0.5)',
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Supply Increase', color: '#94a3b8' },
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(71, 85, 105, 0.3)' }
                            },
                            y: {
                                title: { display: true, text: 'Affordability Ratio', color: '#94a3b8' },
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(71, 85, 105, 0.3)' },
                                min: 5,
                                max: 12
                            }
                        }
                    }
                });
            }
        }

        function updateComparisonTable(b2, b1Mult, filterMult, commuteMult) {
            const tbody = document.getElementById('comparison-body');
            const supplyLevels = [5, 15, 30, 48];

            tbody.innerHTML = supplyLevels.map(s => {
                const paper = getPaperPrediction(s, includeDemand);
                const yours = simulateAffordability(s, b2, b1Mult, filterMult, commuteMult, includeDemand);
                const diff = paper - yours;
                const diffClass = diff > 0 ? 'positive' : 'negative';

                return `
                    <tr>
                        <td>${s}%</td>
                        <td class="paper-col">${paper.toFixed(2)}</td>
                        <td class="yours-col">${yours.toFixed(2)}</td>
                        <td class="delta ${diffClass}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Help modal content
        const helpContent = {
            supply: {
                title: 'Supply Increase (%)',
                body: `
                    <p>This controls <strong>how many new homes are added</strong> to London's housing stock, expressed as a percentage increase.</p>
                    <div class="highlight">
                        <strong>Key reference:</strong> The paper's main scenario is a 48% increase, equivalent to building <strong>1.6 million new homes</strong> in London.
                    </div>
                    <p>The paper tested three scenarios:</p>
                    <p>‚Ä¢ <strong>5%</strong> = ~167,000 homes</p>
                    <p>‚Ä¢ <strong>15%</strong> = ~500,000 homes</p>
                    <p>‚Ä¢ <strong>48%</strong> = 1.6 million homes</p>
                    <p>Move this slider to see how different levels of construction would affect affordability predictions.</p>
                `
            },
            b2: {
                title: 'Supply Effect Coefficient (b‚ÇÇ)',
                body: `
                    <p>This is the <strong>key econometric parameter</strong> that determines how much house prices fall when housing supply increases.</p>
                    <div class="formula">Price Change ‚âà b‚ÇÇ √ó Supply Change</div>
                    <p>The paper estimates <strong>b‚ÇÇ = -0.97</strong>, meaning a 1% increase in housing stock reduces prices by about 0.97%.</p>
                    <div class="highlight">
                        <strong>Why it matters:</strong> This value is estimated with uncertainty. If the true value is more negative (e.g., -1.5 or -2.0), supply increases would be <em>much more effective</em> than the paper suggests.
                    </div>
                    <p>Housing economics literature suggests values ranging from <strong>-0.5 to -2.5</strong> depending on market conditions and methodology.</p>
                `
            },
            b1: {
                title: 'Demand Response (b‚ÇÅ multiplier)',
                body: `
                    <p>This controls <strong>induced demand</strong> ‚Äî the idea that building more homes attracts more workers, partially offsetting the price-reducing effect of new supply.</p>
                    <div class="highlight">
                        <strong>The paper's assumption:</strong> Each new home brings proportional new workers who compete for housing, reducing the price benefit.
                    </div>
                    <p><strong>1.0x</strong> = Paper's full induced demand assumption</p>
                    <p><strong>0.5x</strong> = Half the induced demand (some empty homes, retirees, etc.)</p>
                    <p><strong>0.0x</strong> = No induced demand (pure supply effect)</p>
                    <p>Critics argue the paper <em>overestimates</em> induced demand by assuming every dwelling brings workers. Many homes house retirees, students, or remain empty as investments.</p>
                `
            },
            filter: {
                title: 'Filtering Multiplier',
                body: `
                    <p><strong>Filtering</strong> is a well-documented housing economics phenomenon that the paper completely ignores.</p>
                    <div class="highlight">
                        <strong>How filtering works:</strong> When someone buys a new home, they vacate their old one. That home becomes available to someone else, who vacates <em>their</em> home, and so on ‚Äî creating a "chain" of moves.
                    </div>
                    <p>Each new home built can improve affordability for <strong>multiple households</strong> through this chain effect.</p>
                    <p><strong>1.0x</strong> = No filtering (paper's assumption)</p>
                    <p><strong>1.5x</strong> = Each home helps 1.5 households</p>
                    <p><strong>2.0x</strong> = Each home helps 2 households (empirical estimates)</p>
                    <p>Academic studies suggest multipliers of <strong>1.5-2.5x</strong> are realistic.</p>
                `
            },
            commute: {
                title: 'Commuting Evolution',
                body: `
                    <p>The paper uses <strong>2001 Census commuting data</strong> to model spatial relationships ‚Äî but commuting patterns changed dramatically between 2001 and 2012.</p>
                    <div class="highlight">
                        <strong>Major changes 2001-2012:</strong><br>
                        ‚Ä¢ Oyster card introduced (2003)<br>
                        ‚Ä¢ DLR and Overground expansions<br>
                        ‚Ä¢ Thameslink upgrades<br>
                        ‚Ä¢ Early remote work adoption
                    </div>
                    <p>More diffuse commuting means:</p>
                    <p>‚Ä¢ People can live further from work</p>
                    <p>‚Ä¢ Outer areas become better substitutes for central London</p>
                    <p>‚Ä¢ New supply has a <strong>larger effect</strong> on London prices</p>
                    <p>The "frozen matrix" is one of the paper's most significant methodological flaws.</p>
                `
            }
        };

        function showHelp(topic) {
            const content = helpContent[topic];
            if (!content) return;

            document.getElementById('modal-title').textContent = content.title;
            document.getElementById('modal-body').innerHTML = content.body;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal(event) {
            if (!event || event.target.id === 'modal-overlay') {
                document.getElementById('modal-overlay').classList.remove('active');
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Initialize
        updateModel();
    </script>
</body>

</html>